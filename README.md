## knife-depsolver

Knife plugin that uses Chef Server to calculate cookbook dependencies for a given run_list.

Some features of knife-depsolver:

1. JSON output for easy parsing
2. API error handling provides very helpful information
3. Accepts cookbook version constraints directly in the run_list
4. Useful information such as environment cookbook version constraints, expanded run_list and elapsed time for depsolver request
5. Ordering of depsolver results is maintained rather than sorted so you see what really gets passed to the chef-client

### How Does Cookbook Dependency Solving Work?

During a chef-client run the chef-client expands the node's run_list which means the chef-client recursively expands
any existing role run_lists until the expanded run_list only consists of a list of cookbook recipes.

Then chef-client sends the expanded run_list to the Chef Server's `/organizations/ORGNAME/environments/ENVNAME/cookbook_versions`
API endpoint which is serviced by opscode-erchef.

opscode-erchef gets the ORGNAME organization's cookbook universe (cookbook dependency info for every version of every cookbook)
and the ENVNAME environment's cookbook version constraints from the database.

opscode-erchef sends the expanded run_list, environment constraints and cookbook universe to a ruby process running the
[depselector.rb script](https://github.com/chef/chef-server/blob/12.9.1/src/oc_erchef/apps/chef_objects/priv/depselector_rb/depselector.rb).

This script uses the [dep_selector gem](https://github.com/chef/dep-selector) to build a dependency graph that filters out any
cookbook versions that don't satisfy the environment cookbook version constraints.

The dep_selector gem re-formulates the dependency graph and the solution constraints as a CSP and off-loads the hard work to
[Gecode](http://www.gecode.org/), a fast, license-friendly solver written in C++. If Gecode returns a solution then that is used by opscode-erchef
to send a list of cookbook file metadata back to the chef-client so it can synchronize its cookbook cache.

!!!!!!!upgrade your chef server!!!!!!!




### Install

```
chef gem install knife-depsolver
```

### Usage

Find the depsolver solution for an arbitrary run_list.
Specifying recipes and even cookbook version constraints is allowed.

```
knife depsolver 'cookbook-B,cookbook-A::foo@3.1.4,cookbook-R'
```

Find the depsolver solution for an arbitrary run_list using a specific environment's cookbook version constraints.
Specifying recipes and even cookbook version constraints is allowed.

```
knife depsolver -E production 'cookbook-B,cookbook-A::foo@3.1.4,cookbook-R'
```

Find the depsolver solution for a node's run_list.

```
knife depsolver -n demo-node
```

Find the depsolver solution for a node's run_list using a specific environment's cookbook version constraints.

```
knife depsolver -E production -n demo-node
```

### Chef DK's Embedded Depsolver

what versions of Chef DK match what versions of Chef Server?

knife-depsolver --local-depsolver option requires universe data
  chef server 12.4.0 added the /universe endpoint

chef dk 0.17.17 has new dep_selector 1.0.4
https://discourse.chef.io/t/chef-dk-0-17-17-released/9203    2016-08-17
https://github.com/chef/chef-dk/commit/5e13ef95a3df550b9466b231c123a6d43b9fc168
chef dk 0.16.28  has older dep_selector 1.0.3
chef gem list dep_selector

chef server 12.9.0 introduced new dep_selector 1.0.4
https://discourse.chef.io/t/chef-server-12-9-0-released/9493   2016-09-22
https://github.com/chef/chef-server/tree/12.9.0
12.8.0 has 1.0.3
dep_selector 1.0.3 was released 2014-04-22
https://github.com/chef/dep-selector/commit/7a75df69ae482768b439a28ab5e237459c6fa263
depselector.rb hasn't changed much at all since 2013-08-23 around the time it was originally brought into erchef
https://github.com/chef/chef_objects/commits/master/priv/depselector_rb/depselector.rb
/opt/opscode/embedded/bin/gem list dep


### Local Depsolver Usage

If we are hitting a depsolver timeout issue in the Chef Server it becomes difficult to identify the source of the problem.

We can use the depsolver embedded in our workstation's Chef DK to make an identical calculation as the Chef Server but with
a configurable timeout to give the depsolver more time.

If this allows the depsolver to finish then the results can help us identify the cause of the slow depsolver calculation.

```
knife depsolver -n NODENAME --local-depsolver --timeout 120000
```

and if we want to reproduce what the customer is seeing we can ask them to send us the files generated by the following two commands

```
knife depsolver -n NODENAME  --capture-env-constraints FILENAME --capture-universe FILENAME > depsolver_results.txt
```

let's say the expanded run_list in depsolver_results.txt is 'cookbook-A,cookbook-B@1.2.3'
then we can do the following to perfectly simulate what the customer is seeing

```
knife depsolver --env-constraints FILENAME --universe FILENAME 'cookbook-A,cookbook-B@1.2.3'
```
